<div class="avisos-cont">
	<p class="titulo">Avisos</p>
	<div class="avisos">
		<div class="carga">
			<div class="texto">Cargando</div>
			<span class="icono icon-spinner2"></span>
		</div>
	</div>
</div>
<div class="avisos-bg">
	<div class="wraper">
		<div class="cerrar"><span class="icon-cross"></span></div>
	</div>
</div>

<script type="text/javascript">
(function($, $elem){
	if(!window.unprg) window.unprg = {};

	var avisos = {

		options : {
			timeChange 		: 800,    	//tiempo de transi칩n al deslizar aviso
			timeChangeDelay : 60,    	//tiempo de respuesta para desizamiento
			timeWait 		: 3600,	   	//tiempo entre cada deslizamiento de avisos
			timeBgShow  	: 400,    	//tiempo de transici칩n de aviso emergente
			timeBgInit		: 1500,   	//tiempo para mostrar el aviso emergente desde la carga de la p치gina
			playOnlyScroll	: false,  	//si es verdadero solo se anima cuando hay escroll
			stopOnHover		: true,    	//si es verdadero la reproducci칩n se detiene al posicionar el mouse
			absPath 		: "/16/", 	//indica la carpeta interna del proyecto
			jsonPath 		: "/16/backend/avisos.json"	//indica la ruta de los avisos
		},

		init : function(){
			var base = this;
			base.$elem = $elem;
			base.$container = base.$elem.find('.avisos');
			base.$background = base.$elem.find('.avisos-bg');
			base.items = {};
			base.loadItems();
		},

		startSlide : function(){
			var base = this;
			base.$background.find('.icon-cross').click(function(event) {
				base.$background.fadeOut(base.options.timeBgShow);
			});
			base.$container.find('.aviso-wrap').first().find('.aviso').addClass('primero');
			if(base.options.stopOnHover) base.stopOnHover();
			base.showEmergente();
			base.play();
		},

		play : function(){
			var base = this;
			window.clearInterval(base.playInterval);
			if(base.options.playOnlyScroll===true && base.$elem.find('.avisos-cont').height()<=base.$elem.height()){
				return false;
			}
			base.playInterval = window.setInterval(function(){
				base.slide();
			}, base.options.timeWait);
		},

		stop : function(){
			var base = this;
			window.clearInterval(base.playInterval);
		},

		stopOnHover : function(){
			var base = this;
			base.$elem.on("mouseover", function () {
                base.stop();
            });
            base.$elem.on("mouseout", function () {
                base.play();
            });
		},

		getTransition : function(time){
			return {
				'-webkit-transition': 'all '+time+'ms',
				'-moz-transition' 	: 'all '+time+'ms',
				'-o-transition'		: 'all '+time+'ms',
				'-ms-transition'	: 'all '+time+'ms',
				'transition' 		: 'all '+time+'ms'
			};
		},

		slide : function(){
			var base = this, item, clon;
			item = base.$container.find('.aviso-wrap').first().css(base.getTransition(0));
			clon = item.clone().addClass('aviso-hide');
			base.$container.append(clon);
			window.setTimeout(function(){
				item.css(base.getTransition(base.options.timeChange));
				item.addClass('aviso-hide');
			}, 0);
			window.setTimeout(function(){
				clon.css(base.getTransition(base.options.timeChange));
				clon.removeClass('aviso-hide');
			}, base.options.timeChangeDelay);
			window.setTimeout(function(){
				item.remove();
			}, base.options.timeChange);
		},

		loadItems : function(){
			var base = this, 
				time = 0;
			$.getJSON(base.options.jsonPath)
				.done(function(data){
					base.status = true;
					base.$container.find('.carga').remove();
					$.each(data.avisos, function(index, el) {
						base.addItem(el);
					});
					window.setTimeout(function(){
						base.startSlide();
					},base.options.timeChange+base.options.timeChangeDelay*2);
				})
				.fail(function(data){
					base.status = false;
					base.$container.find('.carga .icono').remove();
					base.$container.find('.carga .texto').text('Error al cargar contenido');
					console.log(data);
				});
		},

		addItem : function(aviso){
			var base = this, item, bg, desplegar;
			bg = $('<div/>').addClass('contenido').attr('data-id', aviso.id);
			if(aviso.img){
				bg.append($('<img/>').attr({
					'src'  : base.options.absPath+aviso.img,
					'class': 'img',
					'alt'  : 'comunicado'
				}));
			}else{
				bg.append($('<embed/>').attr({
					'src'  : base.options.absPath+aviso.doc,
					'class': 'pdf',
					'type' : 'application/pdf'
				}));
			}
			base.items[aviso.id] = {
				'id' 		: aviso.id,
				'fecha' 	: aviso.fecha,
				'emergente'	: aviso.emergente,
				'texto' 	: aviso.texto,
				'bg' 		: bg,
				'load' 		: false
			};
			item = $("<div/>").addClass('aviso').attr('data-id',aviso.id);
			item.append($("<p/>").addClass('aviso__texto').text(aviso.texto));
			item.append($("<p/>").addClass('aviso__fecha').text('@'+aviso.fecha));
			item = $("<div/>").addClass('aviso-wrap').attr('data-id',aviso.id).append(item);
			item.click(function(event) {
				base.desplegar($(this).data('id'));
			});
			item.addClass('aviso-hide').css(base.getTransition(base.options.timeChange));
			base.$container.append(item);
			window.setTimeout(function(){
				item.removeClass('aviso-hide');
			}, base.options.timeChangeDelay);
		},

		desplegar : function(idAviso){
			var base = this;
			if(base.items[idAviso].load === false){
				base.items[idAviso].load = true;
				base.$background.find('.wraper').append(base.items[idAviso].bg);
			}
			base.$background.find('.contenido').each(function(index, el) {
				$(el).hide();
			});
			base.$background.find('.contenido[data-id='+idAviso+']').show();
			base.$background.fadeIn(base.options.timeBgShow);
		},

		showEmergente : function(){
			var base = this;
			if(base.status === false) return false;
			$.each(base.items, function(index, el) {
				if(el.emergente)base.desplegar(el.id);
			});
			base.$background.fadeIn(base.options.timeBgShow);
		}

	};

	window.unprg.avisos = avisos;

	$(document).ready(function(){
		window.unprg.avisos.init();
	});

})(jQuery, $('.unprg-avisos'));
</script>